#include <bits/stdc++.h>
using namespace std;

class Book {
private:
    string isbn, title, author, genre;
    int year;
    bool available;

public:
    Book() {}
    Book(string isbn, string title, string author, string genre, int year, bool available = true)
        : isbn(isbn), title(title), author(author), genre(genre), year(year), available(available) {}

    string getISBN() const { return isbn; }
    string getTitle() const { return title; }
    string getAuthor() const { return author; }
    string getGenre() const { return genre; }
    int getYear() const { return year; }
    bool isAvailable() const { return available; }

    void setAvailable(bool status) { available = status; }

    void display() const {
        cout << left << setw(15) << isbn
             << setw(25) << title
             << setw(20) << author
             << setw(15) << genre
             << setw(8) << year
             << (available ? "Available" : "Borrowed") << endl;
    }

    string toCSV() const {
        return isbn + "," + title + "," + author + "," + genre + "," + to_string(year) + "," + (available ? "1" : "0");
    }

    static Book fromCSV(const string &line) {
        stringstream ss(line);
        string isbn, title, author, genre, yearStr, availStr;
        getline(ss, isbn, ',');
        getline(ss, title, ',');
        getline(ss, author, ',');
        getline(ss, genre, ',');
        getline(ss, yearStr, ',');
        getline(ss, availStr, ',');
        return Book(isbn, title, author, genre, stoi(yearStr), availStr == "1");
    }
};

class Library {
private:
    vector<Book> books;

public:
    void addBook(const Book &book) {
        books.push_back(book);
        cout << "âœ… Book added successfully!\n";
    }

    void removeBook(const string &isbn) {
        auto it = remove_if(books.begin(), books.end(), [&](const Book &b) { return b.getISBN() == isbn; });
        if (it != books.end()) {
            books.erase(it, books.end());
            cout << "ðŸ—‘ï¸ Book removed successfully!\n";
        } else cout << "âŒ Book not found!\n";
    }

    void updateBook(const string &isbn) {
        for (auto &b : books) {
            if (b.getISBN() == isbn) {
                string newTitle, newAuthor, newGenre;
                int newYear;
                cout << "Enter new title: "; getline(cin, newTitle);
                cout << "Enter new author: "; getline(cin, newAuthor);
                cout << "Enter new genre: "; getline(cin, newGenre);
                cout << "Enter new year: "; cin >> newYear;
                cin.ignore();
                b = Book(isbn, newTitle, newAuthor, newGenre, newYear);
                cout << "âœ… Book updated!\n";
                return;
            }
        }
        cout << "âŒ Book not found!\n";
    }

    void searchBook(const string &key) const {
        bool found = false;
        for (const auto &b : books) {
            if (b.getTitle().find(key) != string::npos || b.getISBN() == key) {
                b.display();
                found = true;
            }
        }
        if (!found) cout << "ðŸ” No matching book found.\n";
    }

    void displayAll() const {
        cout << left << setw(15) << "ISBN" << setw(25) << "Title" << setw(20)
             << "Author" << setw(15) << "Genre" << setw(8) << "Year" << "Status\n";
        cout << string(90, '-') << endl;
        for (const auto &b : books) b.display();
    }

    void statisticsByGenre() const {
        map<string, int> count;
        for (const auto &b : books)
            count[b.getGenre()]++;
        cout << "\nðŸ“Š Books by Genre:\n";
        for (auto &pair : count)
            cout << "  - " << setw(15) << pair.first << ": " << pair.second << endl;
    }

    void saveToFile(const string &filename) const {
        ofstream fout(filename);
        for (const auto &b : books)
            fout << b.toCSV() << endl;
        fout.close();
        cout << "ðŸ’¾ Data saved to " << filename << endl;
    }

    void loadFromFile(const string &filename) {
        ifstream fin(filename);
        if (!fin) return;
        string line;
        while (getline(fin, line)) {
            if (!line.empty()) books.push_back(Book::fromCSV(line));
        }
        fin.close();
    }
};

int main() {
    Library lib;
    lib.loadFromFile("library_data.txt");
    int choice;
    do {
        cout << "\n======= LIBRARY MANAGEMENT SYSTEM =======\n";
        cout << "1. Add Book\n2. Remove Book\n3. Update Book\n4. Search Book\n";
        cout << "5. Display All Books\n6. Statistics by Genre\n7. Save & Exit\n";
        cout << "=========================================\n";
        cout << "Your choice: ";
        cin >> choice;
        cin.ignore();
        switch (choice) {
        case 1: {
            string isbn, title, author, genre;
            int year;
            cout << "Enter ISBN: "; getline(cin, isbn);
            cout << "Enter title: "; getline(cin, title);
            cout << "Enter author: "; getline(cin, author);
            cout << "Enter genre: "; getline(cin, genre);
            cout << "Enter year: "; cin >> year;
            cin.ignore();
            lib.addBook(Book(isbn, title, author, genre, year));
            break;
        }
        case 2: {
            string isbn;
            cout << "Enter ISBN to remove: "; getline(cin, isbn);
            lib.removeBook(isbn);
            break;
        }
        case 3: {
            string isbn;
            cout << "Enter ISBN to update: "; getline(cin, isbn);
            lib.updateBook(isbn);
            break;
        }
        case 4: {
            string key;
            cout << "Enter title or ISBN to search: "; getline(cin, key);
            lib.searchBook(key);
            break;
        }
        case 5:
            lib.displayAll();
            break;
        case 6:
            lib.statisticsByGenre();
            break;
        case 7:
            lib.saveToFile("library_data.txt");
            cout << "ðŸ‘‹ Exiting...\n";
            break;
        default:
            cout << "âŒ Invalid choice!\n";
        }
    } while (choice != 7);
    return 0;
}
